name: Build ROCm wheels

on:
  workflow_dispatch:

jobs:
  build-rocm-wheels:
    name: Build ROCm wheel - Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest-l
    container:
      image: rocm/dev-ubuntu-22.04:7.1-complete
      options: --user root
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Patch pyproject.toml for ROCm
        run: |
          sed -i 's/name = "fastsafetensors"/name = "fastsafetensors-rocm-test"/' pyproject.toml
          echo "Patched pyproject.toml:"
          grep "^name = " pyproject.toml

      - name: Install system dependencies
        run: |
          # Prevent interactive prompts during package installation
          export DEBIAN_FRONTEND=noninteractive
          export TZ=Etc/UTC

          apt-get update
          apt-get install -y \
            software-properties-common \
            wget \
            build-essential \
            libnuma-dev \
            gcc \
            g++ \
            make \
            git \
            curl \
            ca-certificates \
            patchelf

      - name: Install Python ${{ matrix.python-version }}
        run: |
          # Prevent interactive prompts during package installation
          export DEBIAN_FRONTEND=noninteractive
          export TZ=Etc/UTC

          PY_VER="${{ matrix.python-version }}"

          # Check if Python dev package is available in Ubuntu repos
          apt-get update
          if apt-cache show python${PY_VER}-dev 2>/dev/null | grep -q "Package: python${PY_VER}-dev"; then
            echo "Installing Python ${PY_VER} from Ubuntu repositories"
            apt-get install -y \
              python${PY_VER} \
              python${PY_VER}-dev \
              python${PY_VER}-venv
          else
            # If not available in Ubuntu repos, install using pyenv
            echo "Python ${PY_VER} not in Ubuntu repos, installing via pyenv from python.org"

            # Install pyenv dependencies
            apt-get install -y \
              libssl-dev \
              zlib1g-dev \
              libbz2-dev \
              libreadline-dev \
              libsqlite3-dev \
              libncursesw5-dev \
              xz-utils \
              tk-dev \
              libxml2-dev \
              libxmlsec1-dev \
              libffi-dev \
              liblzma-dev

            # Install pyenv
            export PYENV_ROOT="/root/.pyenv"
            curl https://pyenv.run | bash
            export PATH="$PYENV_ROOT/bin:$PATH"
            eval "$(pyenv init -)"

            # Install Python from official python.org releases
            pyenv install ${PY_VER}
            pyenv global ${PY_VER}

            # Create symlink so python${PY_VER} command works
            INSTALLED_VERSION=$(ls /root/.pyenv/versions/ | grep "^${PY_VER}")
            ln -sf /root/.pyenv/versions/${INSTALLED_VERSION}/bin/python /usr/local/bin/python${PY_VER}
            echo "Created symlink: /usr/local/bin/python${PY_VER} -> /root/.pyenv/versions/${INSTALLED_VERSION}/bin/python"
          fi

          # Verify installation
          python${PY_VER} --version

      - name: Create virtual environment and install build dependencies
        run: |
          PY_VER="${{ matrix.python-version }}"

          # Create virtual environment
          python${PY_VER} -m venv /opt/venv

          # Activate venv and install dependencies
          . /opt/venv/bin/activate

          # Upgrade pip and install build tools
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install build setuptools_scm pybind11 numpy auditwheel

          # Verify
          python --version
          pip --version

      - name: Set ROCm environment variables
        run: |
          echo "ROCM_PATH=/opt/rocm" >> $GITHUB_ENV
          echo "HIP_PATH=/opt/rocm/hip" >> $GITHUB_ENV
          echo "/opt/rocm/bin" >> $GITHUB_PATH
          echo "/opt/rocm/hip/bin" >> $GITHUB_PATH
          echo "/opt/venv/bin" >> $GITHUB_PATH

          # Verify ROCm installation
          ls -la /opt/rocm/ || echo "Warning: /opt/rocm not found"
          hipify-perl --version || echo "Warning: hipify-perl not working"

      - name: Build wheel for ROCm
        run: |
          # Activate venv
          . /opt/venv/bin/activate

          # The setup.py should detect ROCm and use hipify-perl automatically
          python -m pip wheel . -w wheelhouse/ --no-deps -v
        env:
          ROCM_PATH: /opt/rocm
          HIP_PATH: /opt/rocm/hip

      - name: List built wheels
        run: |
          ls -lah wheelhouse/

      - name: Repair wheel with auditwheel to create manylinux wheel
        run: |
          # Activate venv
          . /opt/venv/bin/activate

          # Use auditwheel to repair and convert to manylinux wheel
          mkdir -p wheelhouse_repaired
          for wheel in wheelhouse/*.whl; do
            echo "Repairing wheel: $wheel"
            auditwheel repair "$wheel" -w wheelhouse_repaired/ || {
              echo "auditwheel repair failed, copying original wheel"
              cp "$wheel" wheelhouse_repaired/
            }
          done

          # Replace original wheelhouse with repaired wheels
          rm -rf wheelhouse
          mv wheelhouse_repaired wheelhouse

          echo "Repaired wheels:"
          ls -lah wheelhouse/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: rocm-wheel-py${{ matrix.python-version }}
          path: wheelhouse/*.whl
          if-no-files-found: error

  build-sdist:
    name: Build ROCm source distribution
    runs-on: ubuntu-latest-l
    container:
      image: rocm/dev-ubuntu-22.04:7.1-complete
      options: --user root

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Patch pyproject.toml for ROCm
        run: |
          sed -i 's/name = "fastsafetensors"/name = "fastsafetensors-rocm-test"/' pyproject.toml
          echo "Patched pyproject.toml:"
          grep "^name = " pyproject.toml

      - name: Install system dependencies
        run: |
          # Prevent interactive prompts during package installation
          export DEBIAN_FRONTEND=noninteractive
          export TZ=Etc/UTC

          apt-get update
          apt-get install -y \
            software-properties-common \
            python3.11 \
            python3.11-dev \
            python3.11-venv \
            build-essential \
            git

      - name: Create virtual environment and install build tools
        run: |
          # Create virtual environment
          python3.11 -m venv /opt/venv

          # Activate venv and install dependencies
          . /opt/venv/bin/activate

          # Upgrade pip and install build tools
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install build

          # Verify
          python --version
          pip --version

      - name: Build sdist
        run: |
          # Activate venv
          . /opt/venv/bin/activate

          # Build source distribution
          python -m build --sdist --outdir dist/

      - name: List built sdist
        run: |
          ls -lah dist/

      - name: Upload sdist artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz
          if-no-files-found: error

  upload:
    name: Upload ROCm wheels and sdist
    needs: [build-rocm-wheels, build-sdist]
    runs-on: ubuntu-latest-l

    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: rocm-wheel-*
          merge-multiple: false

      - name: Download sdist artifact
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: Flatten all artifacts
        run: |
          mkdir final_dist
          find dist -name '*.whl' -exec cp {} final_dist/ \;
          find dist -name '*.tar.gz' -exec cp {} final_dist/ \;

      - name: List all built artifacts
        run: |
          echo "Built ROCm packages:"
          ls -lah final_dist/

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: final_dist
          path: final_dist

#    - name: Set up Python
#      uses: actions/setup-python@v5
#      with:
#        python-version: "3.11"
#    - name: Publish to PyPI
#      run: |
#        python -m pip install twine
#        twine upload --non-interactive final_dist/*
#      env:
#        TWINE_USERNAME: __token__
#        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}